name: CI/CD Node App - EC2 Deploy (ed25519 + webfactory)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-test-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run tests (optional - replace later)
        run: echo "Add your tests here: npm test"

      - name: Create build artifact
        run: |
          zip -r node-app.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x ".github/*" \
            -x "*.log"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: node-app.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build-test-upload
    env:
      HOST: ${{ secrets.HOST }}
      PORT: ${{ secrets.PORT }}
      USERNAME: ${{ secrets.USERNAME }}
      SSH_KEY: ${{ secrets.SSH_KEY }}

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Install SSH client & rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client rsync

      - name: Setup SSH Agent (Supports ed25519)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.PORT }} \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
              "echo 'SSH OK'; whoami; pwd; uptime"

      - name: Copy app to EC2
        run: |
          echo "Copying node-app.zip to EC2..."
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.PORT }} \
              node-app.zip \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/ubuntu/nodejs-app/

      - name: Deploy on EC2
        run: |
          echo "Deploying app on EC2..."
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.PORT }} \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            # Create directory if not exists
            mkdir -p /home/ubuntu/nodejs-app

            # Go to app directory
            cd /home/ubuntu/nodejs-app

            # Backup previous code (optional)
            [ -d "backup" ] || mkdir backup
            [ -f "node-app.zip" ] && mv node-app.zip backup/node-app-$(date +%s).zip

            # Unzip new version
            unzip -o node-app.zip

            # Install production dependencies
            npm install --production

            # Start or restart with PM2
            pm2 delete nodejs-app 2>/dev/null || true
            pm2 start server.js --name nodejs-app --update-env

            # Save PM2 process list
            pm2 save

            # Show status
            pm2 status
            echo "Deployment completed successfully!"
          EOF

      - name: Success Message
        run: echo "Deployed to EC2 at http://${{ secrets.HOST }}:3000"
