name: CI/CD Node App - EC2 Deploy (ed25519 + webfactory)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-test-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run tests (optional)
        run: echo "Add tests later: npm test"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: .
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build-test-upload

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Install SSH & rsync
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-client rsync

      - name: Setup SSH Agent (ed25519 supported)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Test SSH Connection
        run: |
          echo "Connecting to ${{ secrets.HOST }}..."
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.PORT }} \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
              "echo 'âœ… SSH OK'; whoami; pwd"

      - name: Copy app to EC2
        run: |
          echo "Uploading app files..."
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.PORT }} \
              -r ./* \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/ubuntu/nodejs-app/

      - name: Deploy on EC2
        run: |
          echo "Deploying application..."
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.PORT }} \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            APP_DIR="/home/ubuntu/nodejs-app"
            cd "$APP_DIR"
            npm install --production
            pm2 delete nodejs-app 2>/dev/null || true
            pm2 start server.js --name nodejs-app --update-env
            pm2 save
            pm2 status
            echo "âœ… Deployment successful!"
          EOF

      - name: Success
        run: echo "ðŸŽ‰ App deployed! Visit: http://${{ secrets.HOST }}:3000"
